<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>使用cropper实现图片裁剪功能并保存图片到数据库 - 淡定的分享</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content="laravel,php,cropper,javascript">
  
    <meta name="description" content="活着是需要坐标的，虽然回不去，可是看得见，博客的意义正在于此">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="淡定的分享" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/style.css">
</head></html>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">淡定的分享</a>
    <div class="subtitle">这些年我都做了什么事？</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">归档</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">使用cropper实现图片裁剪功能并保存图片到数据库</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2018-01-01</span>
  </div>
  <div class="post-content">
    <blockquote>
<p>今天实现了图片裁剪上传的功能，写下这篇blog，预防以后忘记</p>
<blockquote>
<p>图片外链托管在github,图片无法加载请自备梯子</p>
</blockquote>
</blockquote>
<h1 id="（1）前端实现"><a href="#（1）前端实现" class="headerlink" title="（1）前端实现"></a>（1）前端实现</h1><h2 id="（1-1）cropper插件介绍"><a href="#（1-1）cropper插件介绍" class="headerlink" title="（1.1）cropper插件介绍"></a>（1.1）cropper插件介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们可以使用 cropper插件实现裁切和缩略图功能</span><br><span class="line">下载地址为：https://github.com/fengyuanchen/cropper</span><br></pre></td></tr></table></figure>

<h2 id="（1-2）cropper插件使用"><a href="#（1-2）cropper插件使用" class="headerlink" title="（1.2）cropper插件使用"></a>（1.2）cropper插件使用</h2><h3 id="（1-2-1）准备"><a href="#（1-2-1）准备" class="headerlink" title="（1.2.1）准备"></a>（1.2.1）准备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">解压下载下来的压缩包</span><br><span class="line">并把dist目录下的：cropper.min.js和cropper.min.css文件复制到项目目录下</span><br></pre></td></tr></table></figure>

<h3 id="（1-2-2）引入类库"><a href="#（1-2-2）引入类库" class="headerlink" title="（1.2.2）引入类库"></a>（1.2.2）引入类库</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--使用绝对路径引入类库，因为cropper是基于jquery的，所以jquery也要引入--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/cropper.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/cropper.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="（1-2-3）html结构"><a href="#（1-2-3）html结构" class="headerlink" title="（1.2.3）html结构"></a>（1.2.3）html结构</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;&#123; route('setface') &#125;&#125;"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  &#123;&#123; csrf_field() &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-div"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"face"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 预览图片区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img-container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"pre_image"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 三个缩略图预区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"docs-preview clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img-preview preview-lg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img-preview preview-md"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"img-preview preview-sm"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 保存裁切参数的四个框 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"x"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"y"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"w"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"h"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-div"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"确认"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="（1-2-4）样式文件"><a href="#（1-2-4）样式文件" class="headerlink" title="（1.2.4）样式文件"></a>（1.2.4）样式文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="selector-tag">--</span>在头部把样式文件导入，也可以自己修改样式控制裁剪框<span class="selector-tag">--</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="selector-class">.img-container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">240px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">240px</span>;</span><br><span class="line">        <span class="attribute">float</span>:left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.img-container</span> <span class="selector-id">#pre_image</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.img-preview</span> &#123;</span><br><span class="line">        <span class="attribute">float</span>: left;</span><br><span class="line">        <span class="attribute">overflow</span>: hidden;</span><br><span class="line">        <span class="attribute">margin-left</span>: <span class="number">20px</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.preview-lg</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">240px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">240px</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.preview-md</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">80px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">80px</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.preview-sm</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">35px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">35px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="（1-2-5）js代码"><a href="#（1-2-5）js代码" class="headerlink" title="（1.2.5）js代码"></a>（1.2.5）js代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> preImg = $(<span class="string">"#pre_image"</span>);</span><br><span class="line"><span class="comment">// 获取裁切时的四个框</span></span><br><span class="line"><span class="keyword">var</span> x = $(<span class="string">"input[name=x]"</span>);</span><br><span class="line"><span class="keyword">var</span> y = $(<span class="string">"input[name=y]"</span>);</span><br><span class="line"><span class="keyword">var</span> w = $(<span class="string">"input[name=w]"</span>);</span><br><span class="line"><span class="keyword">var</span> h = $(<span class="string">"input[name=h]"</span>);</span><br><span class="line"><span class="comment">// 选择图片时预览图片 并 调用cropper插件</span></span><br><span class="line">$(<span class="string">"input[name=face]"</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 先消毁，清除一下插件，否则连续调用插件时会失败</span></span><br><span class="line">    preImg.cropper(<span class="string">"destroy"</span>);</span><br><span class="line">    <span class="comment">// this.files[0]：获取当前图片并转成URL地址</span></span><br><span class="line">    <span class="keyword">var</span> url = getObjectUrl( <span class="keyword">this</span>.files[<span class="number">0</span>] );</span><br><span class="line">    <span class="built_in">console</span>.log( url )</span><br><span class="line">    <span class="comment">// 设置url到预览图片上</span></span><br><span class="line">    preImg.attr(<span class="string">'src'</span>, url);</span><br><span class="line">    <span class="comment">// 调出插件</span></span><br><span class="line">    preImg.cropper(&#123;</span><br><span class="line">        aspectRatio: <span class="number">1</span>,         <span class="comment">// 裁切的框形状</span></span><br><span class="line">        preview:<span class="string">'.img-preview'</span>,    <span class="comment">// 显示预览的位置</span></span><br><span class="line">        viewMode:<span class="number">3</span>,                <span class="comment">// 显示模式：图片不能无限缩小，但可以放大</span></span><br><span class="line">        <span class="comment">// 裁切时把参数保存到表单中</span></span><br><span class="line">        crop: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">            x.val( event.detail.x );</span><br><span class="line">            y.val( event.detail.y );</span><br><span class="line">            w.val( event.detail.width );</span><br><span class="line">            h.val( event.detail.height );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 预览时需要使用下面这个函数转换一下</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.createObjectURL != <span class="literal">undefined</span>) &#123;</span><br><span class="line">        url = <span class="built_in">window</span>.createObjectURL(file)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.URL != <span class="literal">undefined</span>) &#123;</span><br><span class="line">        url = <span class="built_in">window</span>.URL.createObjectURL(file)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.webkitURL != <span class="literal">undefined</span>) &#123;</span><br><span class="line">        url = <span class="built_in">window</span>.webkitURL.createObjectURL(file)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="（1-2-6）"><a href="#（1-2-6）" class="headerlink" title="（1.2.6）"></a>（1.2.6）</h3><p>前端实现效果预览<img src="https://raw.githubusercontent.com/tangchunwei/MyImage/master/QQ%E6%88%AA%E5%9B%BE20180604103534.png" alt="预览"></p>
<hr>
<h1 id="（2）后端保存图片到数据库"><a href="#（2）后端保存图片到数据库" class="headerlink" title="（2）后端保存图片到数据库"></a>（2）后端保存图片到数据库</h1><h2 id="2-1-创建迁移文件"><a href="#2-1-创建迁移文件" class="headerlink" title="(2.1)创建迁移文件"></a>(2.1)创建迁移文件</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--为用户表表添加三个字段，用来保存三张缩略图--&gt;</span><br><span class="line">php artisan make:migration add_faces_users --table=users</span><br></pre></td></tr></table></figure>

<h3 id="（2-1-1）编写迁移文件"><a href="#（2-1-1）编写迁移文件" class="headerlink" title="（2.1.1）编写迁移文件"></a>（2.1.1）编写迁移文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Schema</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddFacesUsers</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;string(<span class="string">'bgface'</span>)-&gt;nullable()-&gt;comment(<span class="string">'大脸'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'mdface'</span>)-&gt;nullable()-&gt;comment(<span class="string">'中脸'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'smface'</span>)-&gt;nullable()-&gt;comment(<span class="string">'小脸'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reverse the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;dropColumn([<span class="string">'bgface'</span>,<span class="string">'mdface'</span>,<span class="string">'smface'</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2-1-2）执行迁移"><a href="#（2-1-2）执行迁移" class="headerlink" title="（2.1.2）执行迁移"></a>（2.1.2）执行迁移</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>

<h2 id="2-2-创建表单验证类"><a href="#2-2-创建表单验证类" class="headerlink" title="(2.2)创建表单验证类"></a>(2.2)创建表单验证类</h2><h3 id="（2-2-1）创建验证类文件"><a href="#（2-2-1）创建验证类文件" class="headerlink" title="（2.2.1）创建验证类文件"></a>（2.2.1）创建验证类文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:request FaceRequest</span><br></pre></td></tr></table></figure>

<h3 id="（2-2-2）编写验证规则"><a href="#（2-2-2）编写验证规则" class="headerlink" title="（2.2.2）编写验证规则"></a>（2.2.2）编写验证规则</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">FormRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FaceRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the user is authorized to make this request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the validation rules that apply to the request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">        &lt;!--最大上传大小不能超过<span class="number">4</span>m--&gt;</span><br><span class="line">            <span class="string">'face'</span> =&gt; <span class="string">'required|image|max:4096'</span>,</span><br><span class="line">            <span class="string">'x'</span> =&gt; <span class="string">'required|numeric|min:0'</span>,</span><br><span class="line">            <span class="string">'y'</span> =&gt; <span class="string">'required|numeric|min:0'</span>,</span><br><span class="line">            <span class="string">'w'</span> =&gt; <span class="string">'required|numeric|min:200'</span>,</span><br><span class="line">            <span class="string">'h'</span> =&gt; <span class="string">'required|numeric|min:200'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-配置路由"><a href="#2-3-配置路由" class="headerlink" title="(2.3)配置路由"></a>(2.3)配置路由</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--配置一个用来处理头像的路由--&gt;</span><br><span class="line"><span class="comment">//修改头像</span></span><br><span class="line">Route::post(<span class="string">"/face"</span>,<span class="string">'FaceController@face'</span>)-&gt;name(<span class="string">'setface'</span>);</span><br></pre></td></tr></table></figure>

<h2 id="2-4-FaceController中添加处理头像的代码"><a href="#2-4-FaceController中添加处理头像的代码" class="headerlink" title="(2.4)FaceController中添加处理头像的代码"></a>(2.4)FaceController中添加处理头像的代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--使用composer安装图片处理类--&gt;</span><br><span class="line">composer <span class="keyword">require</span> intervention/image</span><br><span class="line">&lt;!--修改 config/app.php ，注册类到 $providers 数组--&gt;</span><br><span class="line">Intervention\Image\ImageServiceProvider::class</span><br><span class="line">&lt;!--在 $alias 数组中定义类别名--&gt;</span><br><span class="line"><span class="string">'Image'</span>=&gt; Intervention\Image\Facades\Image::class</span><br><span class="line">&lt;!--引入相关类--&gt;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Image</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Storage</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">FaceRequest</span>;</span><br><span class="line">&lt;!--添加face方法--&gt;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">face</span><span class="params">(FaceRequest $req)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($req-&gt;has(<span class="string">'face'</span>) &amp;&amp; $req-&gt;face-&gt;isValid())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 当前图片上传的位置</span></span><br><span class="line">            $oldimage = $req-&gt;face-&gt;path();</span><br><span class="line">            <span class="comment">// 保存原图片</span></span><br><span class="line">            <span class="comment">// 获取当前日期</span></span><br><span class="line">            $date = date(<span class="string">'Ymd'</span>);</span><br><span class="line">            $oriImg = $req-&gt;face-&gt;store(<span class="string">'face/'</span>.$date);  </span><br><span class="line">            <span class="comment">// 打开要处理的图片</span></span><br><span class="line">            $img = Image::make($oldimage);</span><br><span class="line">            <span class="comment">// 裁切图片</span></span><br><span class="line">            $img-&gt;crop((int)$req-&gt;w,(int)$req-&gt;h,(int)$req-&gt;x,(int)$req-&gt;y);</span><br><span class="line">            <span class="comment">// 生成缩略图并保存</span></span><br><span class="line">            <span class="comment">// 拼出这个缩略图的名字</span></span><br><span class="line">            $bgname = str_replace(<span class="string">'face/'</span>.$date.<span class="string">'/'</span>, <span class="string">'face/'</span>.$date.<span class="string">'/bg_'</span>, $oriImg);         </span><br><span class="line">            $img-&gt;resize(<span class="number">240</span>,<span class="number">240</span>);</span><br><span class="line">            $img-&gt;save(<span class="string">'./uploads/'</span>.$bgname);                     </span><br><span class="line">            $mdname = str_replace(<span class="string">'face/'</span>.$date.<span class="string">'/'</span>, <span class="string">'face/'</span>.$date.<span class="string">'/md_'</span>, $oriImg);</span><br><span class="line">            $img-&gt;resize(<span class="number">80</span>,<span class="number">80</span>);</span><br><span class="line">            $img-&gt;save(<span class="string">'./uploads/'</span>.$mdname);         </span><br><span class="line">            $smname = str_replace(<span class="string">'face/'</span>.$date.<span class="string">'/'</span>, <span class="string">'face/'</span>.$date.<span class="string">'/sm_'</span>, $oriImg);</span><br><span class="line">            $img-&gt;resize(<span class="number">35</span>,<span class="number">35</span>);</span><br><span class="line">            $img-&gt;save(<span class="string">'./uploads/'</span>.$smname);       </span><br><span class="line">            <span class="comment">// 先取出用户的信息</span></span><br><span class="line">            $user = User::find( session(<span class="string">'id'</span>) );</span><br><span class="line">            <span class="comment">// 删除原头像</span></span><br><span class="line">            Storage::delete( $user-&gt;face );</span><br><span class="line">            Storage::delete( $user-&gt;bgface );</span><br><span class="line">            Storage::delete( $user-&gt;mdface );</span><br><span class="line">            Storage::delete( $user-&gt;smface );</span><br><span class="line">            <span class="comment">// 更新新脸</span></span><br><span class="line">            $user-&gt;face = $oriImg;</span><br><span class="line">            $user-&gt;bgface = $bgname;</span><br><span class="line">            $user-&gt;mdface = $mdname;</span><br><span class="line">            $user-&gt;smface = $smname;</span><br><span class="line">            $user-&gt;save();</span><br><span class="line">            <span class="comment">// 修改SESSION中的图片</span></span><br><span class="line">            session([</span><br><span class="line">                <span class="string">'smface'</span> =&gt; $smname,</span><br><span class="line">                <span class="string">'bgface'</span> =&gt; $bgname,</span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">return</span> redirect()-&gt;route(<span class="string">'face'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="（3）注意事项"><a href="#（3）注意事项" class="headerlink" title="（3）注意事项"></a>（3）注意事项</h1><ul>
<li>数据库字段要对应正确，不然保存数据库会失败</li>
<li>因为新的头像要保存到session中，所以如果没效果要多清空缓存试试</li>
<li>最重要的是一定要有耐心</li>
<li>注意一下文件的上传大小</li>
<li>有问题请给我发邮件</li>
</ul>

  </div>
  <div class="post-footer">
    
      <ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/cropper/">cropper</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/laravel/">laravel</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/php/">php</a></li></ul>
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>
<footer>
  &copy; 2019
  <span class="author">
    danding
  </span>
</footer>
    </div>
  </body>
</html>